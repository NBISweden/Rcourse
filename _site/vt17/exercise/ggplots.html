<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
	<title>R Courses @ NBIS</title>

        <meta name="description" content="R Courses offered by NBIS">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="http://localhost:4000/img/apple-touch-icon.png">
	<link rel="shortcut icon" href="http://localhost:4000/img/favicon.ico" />

        <link rel="stylesheet" href="http://localhost:4000/css/normalize.css">
        <link rel="stylesheet" href="http://localhost:4000/css/main.css">

	<!-- html5 shim and respond.js ie8 support of html5 elements and media queries -->
	<!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->
    </head>
    <body>
        <!--[if lt IE 9]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

	<header>
	  <img src="http://localhost:4000/img/Rlogo.png" alt="R Logo" /><span>@</span><a href="//nbis.se"><img src="http://localhost:4000/img/nbis.png" alt="NBIS logo" /></a>
	</header>
	<main>
          <h1 id="ggplots-in-r">ggplots in R</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline1">1. Introduction</a></li>
<li><a href="#orgheadline2">2. Execise</a></li>
</ul>
</div>
</div>

<h1 id="introduction">Introduction<a id="orgheadline1"></a></h1>

<p>Even though plotting capabilities of R base are really impressive compared to 
other programming languages, there are other packages available to help you generate
awesome graphics. Two of the more popular packages besides the base
package are <strong>lattice</strong> and <strong>ggplot2</strong>. According to many users, these are superior to
the base plot library, especially when it comes to exploratory data analysis â€“
without too much work, they generate trellis graphics, e.g. graphs that display a
variable or the relationship between variables, conditioned on one or
more other variables. Over the last years ggplot2 has become the
standard plotting library for many R users, especially as it keeps
evolving and new features are added continuously. In addition to being more
convient for certain types of plots, many feel that the default
colors, axis types etc. look better on ggplot2 compared to the base R
and lattice libraries.</p>

<h1 id="exercise">Exercise<a id="orgheadline2"></a></h1>

<p>This exercise will not consist of particular tasks for you to solve.
Instead, the code blocks below will read in data and generate map
plots. Make sure that you can run the code and generate the plot. Once
you have a working code go over the code line by line and try to
obtain a fairly detailed understanding of what is going on. Read the
help for some of the functions and try to replot things with altered arguments (e.g. colors or point shapes).</p>

<p>Before you start you should download the following files to your
working directory:<br />
<a href="../files/Bolaget.csv">Bolaget.csv</a><br />
<a href="../files/coop_Uppsala.kml">coop_Uppsala.kml</a><br />
<a href="../files/ica_Uppsala.kml">ica_Uppsala.kml</a></p>

<p>If you cannot load the library install it either via the menu of
RStudio or by typing <code class="highlighter-rouge">install.packages("ggmap")</code> in R.</p>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="c1"># Load the libraries necessary for working with maps
# Install them if missing
</span><span class="n">library</span><span class="p">(</span><span class="n">ggmap</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">maptools</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">rgdal</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">deldir</span><span class="p">)</span><span class="w">
    
</span><span class="c1"># Download the map of Uppsala from Stamen Maps
</span><span class="n">google.map</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_map</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">17.63</span><span class="p">,</span><span class="m">59.84</span><span class="p">),</span><span class="w"> </span><span class="n">zoom</span><span class="o">=</span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">maptype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'toner'</span><span class="p">)</span><span class="w">
    
</span><span class="c1"># Load the list of System Bolaget shops
</span><span class="n">data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.table</span><span class="p">(</span><span class="s2">"Bolaget.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s2">";"</span><span class="p">,</span><span class="w"> </span><span class="n">quote</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span><span class="w">
    
</span><span class="c1"># Narrow down the list to Uppsala only
</span><span class="n">data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">$</span><span class="n">Address4</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"UPPSALA"</span><span class="p">,]</span><span class="w">
		
</span><span class="c1"># The description in the file says the provided coords are in the RT90 datum.
# The map uses WGS84 thus we need a conversion from RT90 to WGS84:
</span><span class="n">latlonRT90</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="s1">'RT90x'</span><span class="p">,</span><span class="w"> </span><span class="s1">'RT90y'</span><span class="p">)]</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">latlonRT90</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span><span class="s1">'y'</span><span class="p">)</span><span class="w">

</span><span class="c1"># EPSG codes for RT90 and WGS84 are 3021 and 4326, respectively. 
# Here, we do the actual conversion
</span><span class="n">tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">coords.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latlonRT90</span><span class="o">$</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">coords.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latlonRT90</span><span class="o">$</span><span class="n">x</span><span class="p">)</span><span class="w">
</span><span class="n">coordinates</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">=~</span><span class="n">coords.x</span><span class="o">+</span><span class="n">coords.y</span><span class="w">
</span><span class="n">proj4string</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">=</span><span class="n">CRS</span><span class="p">(</span><span class="s2">"+init=epsg:3021"</span><span class="p">)</span><span class="w"> 
</span><span class="n">coords</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">spTransform</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">CRS</span><span class="p">(</span><span class="s2">"+init=epsg:4326"</span><span class="p">))</span><span class="w">
		
</span><span class="c1"># Create the data frame for ggplot2
</span><span class="n">coords</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">coords</span><span class="o">@</span><span class="n">coords</span><span class="p">[,</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">lon</span><span class="o">=</span><span class="n">coords</span><span class="o">@</span><span class="n">coords</span><span class="p">[,</span><span class="m">2</span><span class="p">])</span><span class="w">

</span><span class="c1"># Do the Voronoi tesseleation
</span><span class="n">voronoi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">deldir</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="w">

</span><span class="c1"># Plot the map, shops density, shops as points and the tesselation lines.
</span><span class="n">map</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggmap</span><span class="p">(</span><span class="n">google.map</span><span class="p">)</span><span class="w">
</span><span class="n">map</span><span class="w"> </span><span class="o">+</span><span class="w">
</span><span class="n">stat_density2d</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coords</span><span class="p">,</span><span class="w"> 
	           </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lon</span><span class="p">,</span><span class="w">
			   </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">..level..</span><span class="p">,</span><span class="w">
			   </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">..level..</span><span class="p">),</span><span class="w"> 
			   </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w"> 
			   </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"polygon"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
			   </span><span class="n">scale_fill_gradient</span><span class="p">(</span><span class="n">low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"green"</span><span class="p">,</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"olivedrab"</span><span class="p">,</span><span class="w"> </span><span class="n">guide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
			   </span><span class="n">scale_alpha</span><span class="p">(</span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">),</span><span class="w"> </span><span class="n">guide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
			   </span><span class="n">geom_segment</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">xend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">yend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="m">2</span><span class="p">),</span><span class="w"> 
			                </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">.6</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">voronoi</span><span class="o">$</span><span class="n">dirsgs</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="w"> </span><span class="s2">"olivedrab"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
							</span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">lon</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="s1">'olivedrab'</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="c1"># ICA &amp; Coop
</span><span class="n">ica.kml</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">getKMLcoordinates</span><span class="p">(</span><span class="n">kmlfile</span><span class="o">=</span><span class="s2">"ica_Uppsala.kml"</span><span class="p">,</span><span class="w"> </span><span class="n">ignoreAltitude</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w">
</span><span class="n">tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unlist</span><span class="p">(</span><span class="n">ica.kml</span><span class="p">)</span><span class="w">
</span><span class="n">ica.coords</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">],</span><span class="w"> </span><span class="n">lon</span><span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s1">'ica'</span><span class="p">)</span><span class="w">
</span><span class="n">coop.kml</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">getKMLcoordinates</span><span class="p">(</span><span class="n">kmlfile</span><span class="o">=</span><span class="s2">"coop_Uppsala.kml"</span><span class="p">,</span><span class="w"> </span><span class="n">ignoreAltitude</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w">
</span><span class="n">tmp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unlist</span><span class="p">(</span><span class="n">coop.kml</span><span class="p">)</span><span class="w">
</span><span class="n">coop.coords</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">],</span><span class="w"> </span><span class="n">lon</span><span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s1">'coop'</span><span class="p">)</span><span class="w">
</span><span class="n">coords</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">ica.coords</span><span class="p">,</span><span class="w"> </span><span class="n">coop.coords</span><span class="p">)</span><span class="w">
</span><span class="n">google.map</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_map</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">17.63</span><span class="p">,</span><span class="m">59.84</span><span class="p">),</span><span class="w"> </span><span class="n">zoom</span><span class="o">=</span><span class="m">12</span><span class="p">)</span><span class="w">
</span><span class="n">voronoi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">deldir</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="w">

</span><span class="n">map</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggmap</span><span class="p">(</span><span class="n">google.map</span><span class="p">)</span><span class="w">
	         </span><span class="n">map</span><span class="w"> </span><span class="o">+</span><span class="w">
			 </span><span class="n">scale_fill_gradient</span><span class="p">(</span><span class="n">low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"green"</span><span class="p">,</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"olivedrab"</span><span class="p">,</span><span class="w"> </span><span class="n">guide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
			 </span><span class="n">scale_alpha</span><span class="p">(</span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">),</span><span class="w"> </span><span class="n">guide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
			 </span><span class="n">geom_segment</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">xend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">yend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="m">2</span><span class="p">),</span><span class="w"> 
			 </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">.4</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">voronoi</span><span class="o">$</span><span class="n">dirsgs</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="w"> </span><span class="s2">"olivedrab"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
			 </span><span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="n">type</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

	</main>

	<footer>
	  <a href="//www.nbis.se">NBIS</a>
	</footer>

	


    </body>
</html>
